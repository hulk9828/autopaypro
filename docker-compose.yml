services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: payment_app
    restart: always
    env_file:
      - .env
    environment:
      # Connect to host Postgres; use same user as in .env (POSTGRES_USER/POSTGRES_PASSWORD)
      - DATABASE_URL=postgresql+asyncpg://payment_user:1234@host.docker.internal:5432/payment_db
    extra_hosts:
      # Required on Linux: resolve host.docker.internal to the host (so container can reach host Postgres)
      - "host.docker.internal:host-gateway"
    ports:
      - "0.0.0.0:8018:8018"
    volumes:
      - .:/app
    command: >
      sh -c "alembic upgrade head &&
      uvicorn app.main:app --host 0.0.0.0 --port 8018 --reload"
